<?xml version="1.0"?>
<project name="telscale.restcomm.release" default="release" basedir=".">
	<property environment="sys"/>
    <property name="release.dir" location="${ant.file.telscale.restcomm.release}/../target" />
	<property name="base.dir" location="${ant.file.telscale.restcomm.release}/.." />
	<property name="docs.dir" location="${release.dir}/docs" />
	<property name="restcomm.docs.dir" location="${release.dir}/docs/restcomm" />
	<property name="checkout.dir" value="${base.dir}/checkout" />	
	<property name="checkout.telscale-restcomm.dir" value="${checkout.dir}/telscale-restcomm" />
	<property name="telscale.restcomm.release.version" value="6.1.0.GA"/>
	
	<!--Telscale binaries versions-->
	<property name="telscale-sipservlets.version" value="6.1.3.GA" />
	<property name="telscale-media.version" value="6.1.1.GA" />
	<property name="telscale-lb.version" value="6.1.2.GA" />
	<property name="telscale-diameter.version" value="6.1.2.GA" />
	
	
	<!--GET Telscale-Sip=Servlets & Telscale-Media-Server & Telscale Diameter - properties-->
	<property name="telscale-sipservlets.distro.version" value="${telscale-sipservlets.version}-jboss-as-5.1.0.GA-1306131642" />
	<property name="telscale-sipservlets.download.distro.file" value="TelScale-SIP-Servlets-${telscale-sipservlets.distro.version}.zip" />
	<property name="telscale-sipservlets.download.url" value="ftp://ftp.box.com/TelScale%20SIP%20Servlets/6.1.3.GA/${telscale-sipservlets.download.distro.file}" />
	<property name="telscale-sipservlets.distro.zip.path" value="${checkout.dir}/${telscale-sipservlets.download.distro.file}" />
	
	<!-- TODO: Once productized Media Telscale version available then exchange download link here and version above-->
	<property name="telscale-media.download.distro.file" value="TelScale-media-${telscale-media.version}.zip" />
	<property name="telscale-media.download.url" value="ftp://ftp.box.com/TelScale%20media/${telscale-media.version}/${telscale-media.download.distro.file}" />
	<property name="telscale-media.distro.zip.path" value="${checkout.dir}/${telscale-media.download.distro.file}" />
	
	<property name="telscale-diameter.download.distro.file" value="TelScale-diameter-${telscale-diameter.version}.zip" />
	<property name="telscale-diameter.download.url" value="ftp://ftp.box.com/TelScale%20jDiameter/${telscale-diameter.version}/${telscale-diameter.download.distro.file}" />
	<property name="telscale-diameter.distro.zip.path" value="${checkout.dir}/${telscale-diameter.download.distro.file}" />

	<property name="release.build.goals" value="clean install -DskipTests=true"/>
	<property name="release.build.test.goals" value="clean install"/>
	<property name="release.ts.deploy.goals" value="clean deploy"/>
	
	

	<condition property="mvn.executable" value="${sys.M2_HOME}\bin\mvn.bat" else="mvn">
		<os family="windows"/>
	</condition>
	
	<taskdef onerror="fail" resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${ant.file.mobicents.restcomm.release}/../ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>
	
	<target name="release" depends="clean,get-deps,extract-deps,checkout-restcomm, build-telscale-restcomm, copy-restcomm, copy-docs, make-final-zip" />
	<target name="release-no-clean" depends="get-deps,extract-deps,checkout-restcomm, build-telscale-restcomm, copy-restcomm, copy-docs, make-final-zip" />
	
    <target name="deploy">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release">
    		<property name="release.build.goals" value="${release.ts.deploy.goals}" />
    	</ant>
    </target>
	
    <target name="deploy-no-clean">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release-no-clean">
    		<property name="release.build.goals" value="${release.ts.deploy.goals}" />
    	</ant>
    </target>
	
    <target name="release-test">
    	<ant antfile="${ant.file.telscale.restcomm.release}" target="release">
    		<property name="release.build.goals" value="${release.build.test.goals}" />
    	</ant>
    </target>
	
	
	<!--GET Telscale-Sip=Servlets & Telscale-Media-Server & Telscale Diameter - downloads-->
	
	<target name="get-deps" depends="get-telscale-sipservlets,get-telscale-media,get-telscale-diameter" />
	<target name="extract-deps" depends="extract-telscale-sipservlets,extract-telscale-media,extract-telscale-diameter" />
	
	<!--SipServlets-->
	<available file="${telscale-sipservlets.distro.zip.path}" property="got.telscale-sipservlets" />
	<target name="get-telscale-sipservlets" unless="got.telscale-sipservlets">
		<echo>Downloading Telscale SipServlets version: ${telscale-sipservlets.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-sipservlets.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-sipservlets.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<target name="extract-telscale-sipservlets" depends="get-telscale-sipservlets">
		<delete dir="${checkout.telscale-sipservlets.dir}" failonerror="false" />
		<unzip src="${telscale-sipservlets.distro.zip.path}" dest="${release.dir}">
			<mapper type="glob" from="TelScale-SIP-Servlets-${telscale-sipservlets.version}-jboss-as-5.1.0.GA/*" to="*"/>
		</unzip>
	</target>
	
	<!--Media-->
	<available file="${telscale-media.distro.zip.path}" property="got.telscale-media" />
	<target name="get-telscale-media" unless="got.telscale-media">
		<echo>Downloading Telscale Slee version: ${telscale-media.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-media.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-media.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<target name="extract-telscale-media" depends="get-telscale-media">
		<delete dir="${checkout.telscale-media.dir}" failonerror="false" />
		<unzip src="${telscale-media.distro.zip.path}" dest="${release.dir}/telscale-media"/>
	</target>
	
	<!--diameter-->
	<available file="${telscale-diameter.distro.zip.path}" property="got.telscale-diameter" />
	<target name="get-telscale-diameter" unless="got.telscale-diameter">
		<echo>Downloading Telscale Slee version: ${telscale-diameter.version}</echo>
		<exec failonerror="true" executable="wget">
		    <arg value="--user=telscale-file-server@telestax.com" />
		    <arg value="--password=t31sca13fi13s" />
		    <arg value="${telscale-diameter.download.url}" />
		</exec>
		<move file="${base.dir}/${telscale-diameter.download.distro.file}" todir="${checkout.dir}"/>
	</target>

	<target name="extract-telscale-diameter" depends="get-telscale-diameter">
		<delete dir="${checkout.telscale-diameter.dir}" failonerror="false" />
		<unzip src="${telscale-diameter.distro.zip.path}" dest="${release.dir}/telscale-diameter"/>
	</target>
	
	
    <target name="checkout-restcomm">
        <echo>Checking out restcomm</echo>
        <exec failonerror="true" executable="git">
            <arg value="clone" />
            <arg value="-b" />
            <arg value="ts1" />
            <arg value="https://telscalejenkins:m0b1c3nts@bitbucket.org/telestax/telscale-restcomm.git" />
            <arg value="${checkout.telscale-restcomm.dir}" />
        </exec>
    </target>
	
	<target name="build-telscale-restcomm">
        <echo>Building Telscale Restcomm</echo>
        <exec failonerror="true" executable="${mvn.executable}" dir="${checkout.telscale-restcomm.dir}">
                <arg line="${release.build.goals}" />
        </exec>
        <exec failonerror="true" executable="${mvn.executable}" dir="${checkout.telscale-restcomm.dir}/restcomm.docs">
                <arg line="${release.build.goals} -Ptelscale" />
        </exec>
	</target>

    <target name="copy-restcomm">
        <echo>Copy restcomm </echo>
		<!--default-->
        <copy tofile="${release.dir}/server/default/deploy/telscale-restcomm.war" failonerror="true" 
        	file="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm.war"/>
        <!--copy todir="${release.dir}/server/default/deploy/telscale-restcomm.war" failonerror="true">
                <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm">
                        <include name="**/*" />
                </fileset>
        </copy-->
		<!--all-->
        <copy tofile="${release.dir}/server/all/deploy/telscale-restcomm.war" failonerror="true" 
        	file="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm.war"/>
        <!--copy todir="${release.dir}/server/all/deploy/telscale-restcomm.war" failonerror="true">
                <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.application/target/restcomm">
                        <include name="**/*" />
                </fileset>
        </copy-->
    </target>
	
    <target name="copy-docs">
		<!--docs-->
	    <mkdir dir="${restcomm.docs.dir}"/>
		<copy todir="${restcomm.docs.dir}" failonerror="true">
		        <fileset dir="${checkout.telscale-restcomm.dir}/restcomm.docs/jdocbook-telscale/target/docbook/publish/en-US">
		                <include name="**/*" />
		        </fileset>
		</copy>
    </target>
	
	
	<target name="make-final-zip" depends="set-time-stamp">
		<zip destfile="${base.dir}/TelScale-restcomm-${telscale.restcomm.release.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${release.dir}" prefix="TelScale-restcomm-${telscale.restcomm.release.version}">
				<include name="**" />
			</zipfileset>
		</zip>
	</target>
	
	<target name="set-time-stamp" unless="skip.timestamp">
		<tstamp>
			<format property="time.stamp" pattern="yyMMddHHmm" />
		</tstamp>
	</target>
	
	<target name="clean">
	    <delete dir="${release.dir}"/>
	    <delete dir="${checkout.telscale-restcomm.dir}"/>
	</target>
</project>
